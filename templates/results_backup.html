<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANALYSRESULTAT - SOURCEFUL ENERGY TERMINAL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">
</head>
<body>
    <div class="terminal-container">
        <!-- Terminal Header -->
        <div class="terminal-system-info">
            SOURCEFUL ENERGY ANALYSIS SYSTEM v1.0 - GNU/Linux x86_64<br>
            Copyright (C) 2025 Sourceful Labs AB - Free Software Foundation<br>
            Kernel: sourceful-4.20.0-energy #1 SMP PREEMPT<br>
            Analysis completed successfully.<br>
            sourceful@energy:~$
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="terminal-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }}">
                        {{ category.upper() }}: {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- ASCII Art Logo -->
        <div class="terminal-ascii">
█████╗ ███╗   ██╗ █████╗ ██╗  ██╗   ██╗███████╗
██╔══██╗████╗  ██║██╔══██╗██║  ╚██╗ ██╔╝██╔════╝
███████║██╔██╗ ██║███████║██║   ╚████╔╝ ███████╗
██╔══██║██║╚██╗██║██╔══██║██║    ╚██╔╝  ╚════██║
██║  ██║██║ ╚████║██║  ██║███████╗██║   ███████║
╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚══════╝╚═╝   ╚══════╝
            KOMPLETT ANALYS SLUTFÖRD
        </div>

        <div class="terminal-divider"></div>

        <!-- Analysis Period Info -->
        {% if results and results.metadata %}
        <div class="terminal-prompt">ls -la /proc/energy/analysis_period</div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">START_DATE:</span>
            <span class="terminal-metric-value">{{ results.metadata.start_date[:10] }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">END_DATE:</span>
            <span class="terminal-metric-value">{{ results.metadata.end_date[:10] }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">AREA_CODE:</span>
            <span class="terminal-metric-value">{{ results.metadata.area_code }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">CURRENCY:</span>
            <span class="terminal-metric-value">{{ results.metadata.currency }}</span>
        </div>
        {% endif %}

        <!-- AI Explanation Section -->
        {% if results and results.ai_explanation %}
        <div class="terminal-divider"></div>
        <div class="terminal-prompt">cat /var/log/energy/ai_analysis.log</div>
        <div class="terminal-text" style="background: rgba(0, 255, 0, 0.1); padding: 15px; margin: 10px 0; border-left: 3px solid #00ff00; color: #00ff00; font-size: 16px; line-height: 1.6;">
            {{ results.ai_explanation | safe }}
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Key Metrics -->
        <div class="terminal-prompt">cat /proc/energy/metrics</div>
        
        {% if results and results.analysis %}
        <div class="terminal-metric">
            <span class="terminal-metric-label">TOTAL_PRODUCTION:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.production_total) }} kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">AVG_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_mean_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">TOTAL_REVENUE:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.total_export_value_sek) }} SEK</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">AVG_REVENUE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format(results.analysis.total_export_value_sek / results.analysis.production_total) }} SEK/kWh</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- Negative Price Analysis -->
        <div class="terminal-prompt">grep -E "NEGATIVE|LOSS" /var/log/energy/price_analysis.log</div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">PRODUCTION_NEG_PRICES:</span>
            <span class="terminal-metric-value terminal-error">{{ "%.2f"|format(results.analysis.production_during_negative_prices) }} kWh ({{ "%.1f"|format((results.analysis.production_during_negative_prices / results.analysis.production_total) * 100) }}% av total)</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">NEGATIVE_PRICE_HOURS:</span>
            <span class="terminal-metric-value">{{ results.analysis.negative_price_hours }} av {{ results.analysis.total_hours }} timmar ({{ "%.1f"|format((results.analysis.negative_price_hours / results.analysis.total_hours) * 100) }}%)</span>
        </div>
        
        {% if results.analysis.negative_price_hours > 0 %}
        <div class="terminal-metric">
            <span class="terminal-metric-label">DIRECT_LOSS:</span>
            <span class="terminal-metric-value terminal-error">{{ "%.2f"|format(results.analysis.negative_export_cost_abs_sek) }} {{ results.metadata.currency }}</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">💡 BATTERY_SAVINGS_POTENTIAL:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.production_during_negative_prices * (results.analysis.price_mean_eur_mwh * results.metadata.currency_rate / 1000)) }} {{ results.metadata.currency }} (vid lagring till genomsnittspris)</span>
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Price Statistics -->
        <div class="terminal-prompt">cat /proc/energy/price_stats</div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">MAX_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_max_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">MIN_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_min_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">PRICE_VOLATILITY:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format(results.analysis.price_volatility_std) }} SEK/kWh</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- ASCII Negative Price Chart -->
        <div class="terminal-prompt">cat /proc/negative_prices/production_analysis</div>
        
        <div class="terminal-text" style="font-family: 'VT323', monospace; font-size: 18px; line-height: 1.5; margin: 15px 0; background: rgba(0, 255, 0, 0.05); padding: 20px; border: 1px solid #004400;">
            <div id="negativePriceChart" style="white-space: pre-wrap; word-wrap: break-word; color: #00ff00; overflow-wrap: break-word;">
                Loading production analysis from /proc/energy/negative_prices...
            </div>
        </div>

        <div class="terminal-text" style="font-size: 14px; color: #666666; margin-bottom: 20px;">
            # LEGEND: █ = NEG.PROD, ▓ = POS.PROD, ░ = NO_DATA
        </div>

        {% endif %}

        <!-- Warning if significant negative prices -->
        {% if results and results.analysis and results.analysis.negative_price_hours > 0 and (results.analysis.negative_price_hours / results.analysis.total_hours) > 0.05 %}
        <div class="terminal-error" style="padding: 15px; margin: 20px 0;">
            ⚠️  WARNING: SIGNIFICANT NEGATIVE PRICES DETECTED ⚠️<br><br>
            Din anläggning producerade under {{ "%.1f"|format((results.analysis.negative_price_hours / results.analysis.total_hours) * 100) }}% av tiden när elpriserna var negativa.<br>
            Detta resulterade i en förlust på {{ "%.2f"|format(results.analysis.negative_export_cost_abs_sek) }} SEK.<br><br>
            RECOMMENDATION: Överväg batterilager eller produktionsstyrning.
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Sourceful Energy Pitch -->
        <div class="terminal-prompt">cat /opt/sourceful/marketing/zap_info.txt</div>
        
        <div class="terminal-text" style="background: rgba(255, 170, 0, 0.1); padding: 15px; margin: 10px 0; border-left: 3px solid #ffaa00;">
            <strong style="color: #ffaa00;">SOURCEFUL ENERGY ZAP™</strong> kan hjälpa dig maximera dina intäkter genom:<br><br>
            
            🔋 <strong>INTELLIGENT BATTERILAGER</strong> - Lagra energi när priserna är negativa eller låga<br>
            📊 <strong>PREDIKTIV ANALYS</strong> - Förutse prisfall och optimera produktion<br>
            ⚡ <strong>AUTOMATISK STYRNING</strong> - Släng av produktionen när det kostar pengar<br>
            💰 <strong>INTÄKTSOPTIMERING</strong> - Sälj din lagrade energi när priserna är höga<br><br>
            
            {% if results and results.analysis and results.analysis.negative_export_cost_abs_sek and results.analysis.negative_export_cost_abs_sek > 100 %}
            <span style="color: #00ff00;">POTENTIAL SAVINGS: {{ "%.0f"|format(results.analysis.negative_export_cost_abs_sek) }} SEK/år med ZAP™</span><br>
            {% endif %}
            
            <span style="color: #666666;">Kontakta oss för en kostnadsfri konsultation: info@sourceful.energy</span><br>
            <span style="color: #555555; font-size: 12px;">Sourceful Labs AB - Open Source Energy Solutions</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- Actions -->
        <div class="terminal-prompt">ls /usr/bin/energy_tools</div>
        <div style="margin: 20px 0;">
            <a href="/" class="terminal-button" style="display: inline-block; text-decoration: none; margin-right: 20px;">
                NEW_ANALYSIS
            </a>
            <a href="/status" class="terminal-button" style="display: inline-block; text-decoration: none; margin-right: 20px;">
                SYSTEM_STATUS
            </a>
            <a href="#" onclick="window.print()" class="terminal-button" style="display: inline-block; text-decoration: none;">
                PRINT_REPORT
            </a>
        </div>

        <!-- Data Download Option -->
        {% if results and results.metadata and results.metadata.session_id %}
        <div style="margin: 20px 0;">
            <a href="/download/{{ results.metadata.session_id }}" class="terminal-button" style="display: inline-block; text-decoration: none;">
                DOWNLOAD_RAW_DATA (CSV)
            </a>
        </div>
        {% endif %}

        <!-- Terminal Footer -->
        <div class="terminal-command-line terminal-text" style="text-align: center; color: #666666; margin-top: 40px;">
            Analysis completed - Sourceful Energy Zap daemon ready for next task
        </div>

        <div class="terminal-text" style="text-align: center; margin-top: 20px; color: #555555; font-size: 12px;">
            Sourceful Labs AB • Open Source Energy Solutions • GNU/Linux Compatible
        </div>

        <div class="terminal-text" style="text-align: center; margin-top: 20px;">
            <span class="cursor"></span>
        </div>
    </div>

    <!-- Terminal JavaScript -->
    <script>
        // Terminal typing effect for cursor
        const cursor = document.querySelector('.cursor');
        if (cursor) {
            setInterval(() => {
                cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
            }, 500);
        }

        // ASCII Negative Price Chart Generator - Fokuserad på produktionsfördelning
        function generateNegativePriceChart(analysisData, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !analysisData) {
                container.innerHTML = 'Error: No analysis data available for production analysis';
                return;
            }

            const negativeProduction = analysisData.production_during_negative_prices || 0;
            const totalProduction = analysisData.production_total || 1;
            const positivePriceProduction = totalProduction - negativeProduction;
            const negativeCost = analysisData.negative_export_cost_abs_sek || 0;
            
            if (negativeProduction === 0) {
                container.innerHTML = '🎉 INGA FÖRLUSTER FRÅN NEGATIVA PRISER! 🎉\n\n' +
                                    '         ✓ PERFEKT RESULTAT! ✓\n' +
                                    '     All produktion såldes till\n' +
                                    '       positiva priser.';
                return;
            }

            const width = 60;
            let chart = '';
            
            // Header med key stats - större och tydligare
            chart += `PRODUKTIONSFÖRDELNING UNDER ANALYSPERIODEN\n`;
            chart += `════════════════════════════════════════════════════════════\n\n`;
            
            // Tårtdiagram-liknande visualisering av produktionsfördelning
            const negativePercentage = negativeProduction / totalProduction;
            const positivePercentage = 1 - negativePercentage;
            
            chart += `TOTAL PRODUKTION: ${totalProduction.toFixed(1)} kWh\n\n`;
            
            // Stor horisontell "tårtgraf" med produktionsfördelning
            const barWidth = 50;
            const negativeBars = Math.floor(barWidth * negativePercentage);
            const positiveBars = barWidth - negativeBars;
            
            chart += 'PRODUKTIONSFÖRDELNING:\n';
            chart += '┌' + '─'.repeat(barWidth) + '┐\n';
            chart += '│' + '█'.repeat(negativeBars) + '▓'.repeat(positiveBars) + '│\n';
            chart += '└' + '─'.repeat(barWidth) + '┘\n';
            chart += `  NEGATIV: ${negativeProduction.toFixed(1)} kWh (${(negativePercentage*100).toFixed(1)}%)\n`;
            chart += `  POSITIV: ${positivePriceProduction.toFixed(1)} kWh (${(positivePercentage*100).toFixed(1)}%)\n\n`;
            
            // Vertikal representation för tydligare översikt
            chart += 'FÖRDELNING PER KATEGORI:\n\n';
            
            const maxBarLength = 30;
            const negBar = Math.floor(maxBarLength * negativePercentage);
            const posBar = Math.floor(maxBarLength * positivePercentage);
            
            chart += `NEG.PRISER: ${'█'.repeat(negBar).padEnd(maxBarLength, '.')} ${(negativePercentage*100).toFixed(1)}%\n`;
            chart += `POS.PRISER: ${'▓'.repeat(posBar).padEnd(maxBarLength, '.')} ${(positivePercentage*100).toFixed(1)}%\n\n`;
            
            // Ekonomisk påverkan
            if (negativeCost > 0) {
                chart += 'EKONOMISK ANALYS:\n';
                chart += `DIREKT FÖRLUST:      ${negativeCost.toFixed(0)} SEK\n`;
                
                const avgLossPerKwh = negativeCost / negativeProduction;
                chart += `FÖRLUST PER kWh:     ${avgLossPerKwh.toFixed(3)} SEK\n\n`;
                
                // Batteripotential - fokus på att spara "gratis" el
                const batteryPotential = negativeProduction * 0.5; // Realistisk genomsnittspris
                chart += `💡 BATTERIPOTENTIAL:\n`;
                chart += `SPARBAR ENERGI:      ${negativeProduction.toFixed(1)} kWh\n`;
                chart += `POTENTIELL VINST:    ${batteryPotential.toFixed(0)} SEK\n`;
                chart += `   (vid försäljning till 0.50 SEK/kWh genomsnitt)\n`;
            }
            
            chart += '\n';
            
            // Rekommendationer baserat på andel
            if (negativePercentage > 0.2) {
                chart += '🔴 KRITISKT: >20% av produktionen vid negativa priser!\n';
                chart += '   Stark rekommendation: Batterilager + produktionsstyrning\n';
                chart += '   Sourceful Zap kan optimera detta automatiskt.';
            } else if (negativePercentage > 0.1) {
                chart += '🟡 VARNING: >10% av produktionen vid negativa priser\n';
                chart += '   Överväg batterilager för att lagra "gratis" el\n';
                chart += '   till bättre tider.';
            } else if (negativePercentage > 0.05) {
                chart += '🟢 MÅTTLIG: <10% påverkan från negativa priser\n';
                chart += '   Mindre optimering möjlig med smart styrning.';
            } else {
                chart += '✅ UTMÄRKT: <5% av produktionen vid negativa priser\n';
                chart += '   Din anläggning har redan bra timing!';
            }

            container.innerHTML = chart;
        }

        // Generate charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            {% if results and results.analysis %}
                const analysisData = {
                    negative_price_hours: {{ results.analysis.negative_price_hours }},
                    total_hours: {{ results.analysis.total_hours }},
                    negative_export_cost_abs_sek: {{ results.analysis.negative_export_cost_abs_sek }},
                    production_during_negative_prices: {{ results.analysis.production_during_negative_prices }},
                    production_total: {{ results.analysis.production_total }}
                };
                generateNegativePriceChart(analysisData, 'negativePriceChart');
            {% endif %}
        });
    </script>
</body>
</html>

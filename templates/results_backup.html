<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANALYSRESULTAT - SOURCEFUL ENERGY TERMINAL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">
</head>
<body>
    <div class="terminal-container">
        <!-- Terminal Header -->
        <div class="terminal-system-info">
            SOURCEFUL ENERGY ANALYSIS SYSTEM v1.0 - GNU/Linux x86_64<br>
            Copyright (C) 2025 Sourceful Labs AB - Free Software Foundation<br>
            Kernel: sourceful-4.20.0-energy #1 SMP PREEMPT<br>
            Analysis completed successfully.<br>
            sourceful@energy:~$
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="terminal-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }}">
                        {{ category.upper() }}: {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- ASCII Art Logo -->
        <div class="terminal-ascii">
‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë    ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            KOMPLETT ANALYS SLUTF√ñRD
        </div>

        <div class="terminal-divider"></div>

        <!-- Analysis Period Info -->
        {% if results and results.metadata %}
        <div class="terminal-prompt">ls -la /proc/energy/analysis_period</div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">START_DATE:</span>
            <span class="terminal-metric-value">{{ results.metadata.start_date[:10] }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">END_DATE:</span>
            <span class="terminal-metric-value">{{ results.metadata.end_date[:10] }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">AREA_CODE:</span>
            <span class="terminal-metric-value">{{ results.metadata.area_code }}</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">CURRENCY:</span>
            <span class="terminal-metric-value">{{ results.metadata.currency }}</span>
        </div>
        {% endif %}

        <!-- AI Explanation Section -->
        {% if results and results.ai_explanation %}
        <div class="terminal-divider"></div>
        <div class="terminal-prompt">cat /var/log/energy/ai_analysis.log</div>
        <div class="terminal-text" style="background: rgba(0, 255, 0, 0.1); padding: 15px; margin: 10px 0; border-left: 3px solid #00ff00; color: #00ff00; font-size: 16px; line-height: 1.6;">
            {{ results.ai_explanation | safe }}
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Key Metrics -->
        <div class="terminal-prompt">cat /proc/energy/metrics</div>
        
        {% if results and results.analysis %}
        <div class="terminal-metric">
            <span class="terminal-metric-label">TOTAL_PRODUCTION:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.production_total) }} kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">AVG_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_mean_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">TOTAL_REVENUE:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.total_export_value_sek) }} SEK</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">AVG_REVENUE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format(results.analysis.total_export_value_sek / results.analysis.production_total) }} SEK/kWh</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- Negative Price Analysis -->
        <div class="terminal-prompt">grep -E "NEGATIVE|LOSS" /var/log/energy/price_analysis.log</div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">PRODUCTION_NEG_PRICES:</span>
            <span class="terminal-metric-value terminal-error">{{ "%.2f"|format(results.analysis.production_during_negative_prices) }} kWh ({{ "%.1f"|format((results.analysis.production_during_negative_prices / results.analysis.production_total) * 100) }}% av total)</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">NEGATIVE_PRICE_HOURS:</span>
            <span class="terminal-metric-value">{{ results.analysis.negative_price_hours }} av {{ results.analysis.total_hours }} timmar ({{ "%.1f"|format((results.analysis.negative_price_hours / results.analysis.total_hours) * 100) }}%)</span>
        </div>
        
        {% if results.analysis.negative_price_hours > 0 %}
        <div class="terminal-metric">
            <span class="terminal-metric-label">DIRECT_LOSS:</span>
            <span class="terminal-metric-value terminal-error">{{ "%.2f"|format(results.analysis.negative_export_cost_abs_sek) }} {{ results.metadata.currency }}</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">üí° BATTERY_SAVINGS_POTENTIAL:</span>
            <span class="terminal-metric-value">{{ "%.2f"|format(results.analysis.production_during_negative_prices * (results.analysis.price_mean_eur_mwh * results.metadata.currency_rate / 1000)) }} {{ results.metadata.currency }} (vid lagring till genomsnittspris)</span>
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Price Statistics -->
        <div class="terminal-prompt">cat /proc/energy/price_stats</div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">MAX_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_max_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">MIN_PRICE:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format((results.analysis.price_min_eur_mwh * results.metadata.currency_rate) / 1000) }} {{ results.metadata.currency }}/kWh</span>
        </div>
        
        <div class="terminal-metric">
            <span class="terminal-metric-label">PRICE_VOLATILITY:</span>
            <span class="terminal-metric-value">{{ "%.4f"|format(results.analysis.price_volatility_std) }} SEK/kWh</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- ASCII Negative Price Chart -->
        <div class="terminal-prompt">cat /proc/negative_prices/production_analysis</div>
        
        <div class="terminal-text" style="font-family: 'VT323', monospace; font-size: 18px; line-height: 1.5; margin: 15px 0; background: rgba(0, 255, 0, 0.05); padding: 20px; border: 1px solid #004400;">
            <div id="negativePriceChart" style="white-space: pre-wrap; word-wrap: break-word; color: #00ff00; overflow-wrap: break-word;">
                Loading production analysis from /proc/energy/negative_prices...
            </div>
        </div>

        <div class="terminal-text" style="font-size: 14px; color: #666666; margin-bottom: 20px;">
            # LEGEND: ‚ñà = NEG.PROD, ‚ñì = POS.PROD, ‚ñë = NO_DATA
        </div>

        {% endif %}

        <!-- Warning if significant negative prices -->
        {% if results and results.analysis and results.analysis.negative_price_hours > 0 and (results.analysis.negative_price_hours / results.analysis.total_hours) > 0.05 %}
        <div class="terminal-error" style="padding: 15px; margin: 20px 0;">
            ‚ö†Ô∏è  WARNING: SIGNIFICANT NEGATIVE PRICES DETECTED ‚ö†Ô∏è<br><br>
            Din anl√§ggning producerade under {{ "%.1f"|format((results.analysis.negative_price_hours / results.analysis.total_hours) * 100) }}% av tiden n√§r elpriserna var negativa.<br>
            Detta resulterade i en f√∂rlust p√• {{ "%.2f"|format(results.analysis.negative_export_cost_abs_sek) }} SEK.<br><br>
            RECOMMENDATION: √ñverv√§g batterilager eller produktionsstyrning.
        </div>
        {% endif %}

        <div class="terminal-divider"></div>

        <!-- Sourceful Energy Pitch -->
        <div class="terminal-prompt">cat /opt/sourceful/marketing/zap_info.txt</div>
        
        <div class="terminal-text" style="background: rgba(255, 170, 0, 0.1); padding: 15px; margin: 10px 0; border-left: 3px solid #ffaa00;">
            <strong style="color: #ffaa00;">SOURCEFUL ENERGY ZAP‚Ñ¢</strong> kan hj√§lpa dig maximera dina int√§kter genom:<br><br>
            
            üîã <strong>INTELLIGENT BATTERILAGER</strong> - Lagra energi n√§r priserna √§r negativa eller l√•ga<br>
            üìä <strong>PREDIKTIV ANALYS</strong> - F√∂rutse prisfall och optimera produktion<br>
            ‚ö° <strong>AUTOMATISK STYRNING</strong> - Sl√§ng av produktionen n√§r det kostar pengar<br>
            üí∞ <strong>INT√ÑKTSOPTIMERING</strong> - S√§lj din lagrade energi n√§r priserna √§r h√∂ga<br><br>
            
            {% if results and results.analysis and results.analysis.negative_export_cost_abs_sek and results.analysis.negative_export_cost_abs_sek > 100 %}
            <span style="color: #00ff00;">POTENTIAL SAVINGS: {{ "%.0f"|format(results.analysis.negative_export_cost_abs_sek) }} SEK/√•r med ZAP‚Ñ¢</span><br>
            {% endif %}
            
            <span style="color: #666666;">Kontakta oss f√∂r en kostnadsfri konsultation: info@sourceful.energy</span><br>
            <span style="color: #555555; font-size: 12px;">Sourceful Labs AB - Open Source Energy Solutions</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- Actions -->
        <div class="terminal-prompt">ls /usr/bin/energy_tools</div>
        <div style="margin: 20px 0;">
            <a href="/" class="terminal-button" style="display: inline-block; text-decoration: none; margin-right: 20px;">
                NEW_ANALYSIS
            </a>
            <a href="/status" class="terminal-button" style="display: inline-block; text-decoration: none; margin-right: 20px;">
                SYSTEM_STATUS
            </a>
            <a href="#" onclick="window.print()" class="terminal-button" style="display: inline-block; text-decoration: none;">
                PRINT_REPORT
            </a>
        </div>

        <!-- Data Download Option -->
        {% if results and results.metadata and results.metadata.session_id %}
        <div style="margin: 20px 0;">
            <a href="/download/{{ results.metadata.session_id }}" class="terminal-button" style="display: inline-block; text-decoration: none;">
                DOWNLOAD_RAW_DATA (CSV)
            </a>
        </div>
        {% endif %}

        <!-- Terminal Footer -->
        <div class="terminal-command-line terminal-text" style="text-align: center; color: #666666; margin-top: 40px;">
            Analysis completed - Sourceful Energy Zap daemon ready for next task
        </div>

        <div class="terminal-text" style="text-align: center; margin-top: 20px; color: #555555; font-size: 12px;">
            Sourceful Labs AB ‚Ä¢ Open Source Energy Solutions ‚Ä¢ GNU/Linux Compatible
        </div>

        <div class="terminal-text" style="text-align: center; margin-top: 20px;">
            <span class="cursor"></span>
        </div>
    </div>

    <!-- Terminal JavaScript -->
    <script>
        // Terminal typing effect for cursor
        const cursor = document.querySelector('.cursor');
        if (cursor) {
            setInterval(() => {
                cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
            }, 500);
        }

        // ASCII Negative Price Chart Generator - Fokuserad p√• produktionsf√∂rdelning
        function generateNegativePriceChart(analysisData, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !analysisData) {
                container.innerHTML = 'Error: No analysis data available for production analysis';
                return;
            }

            const negativeProduction = analysisData.production_during_negative_prices || 0;
            const totalProduction = analysisData.production_total || 1;
            const positivePriceProduction = totalProduction - negativeProduction;
            const negativeCost = analysisData.negative_export_cost_abs_sek || 0;
            
            if (negativeProduction === 0) {
                container.innerHTML = 'üéâ INGA F√ñRLUSTER FR√ÖN NEGATIVA PRISER! üéâ\n\n' +
                                    '         ‚úì PERFEKT RESULTAT! ‚úì\n' +
                                    '     All produktion s√•ldes till\n' +
                                    '       positiva priser.';
                return;
            }

            const width = 60;
            let chart = '';
            
            // Header med key stats - st√∂rre och tydligare
            chart += `PRODUKTIONSF√ñRDELNING UNDER ANALYSPERIODEN\n`;
            chart += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            // T√•rtdiagram-liknande visualisering av produktionsf√∂rdelning
            const negativePercentage = negativeProduction / totalProduction;
            const positivePercentage = 1 - negativePercentage;
            
            chart += `TOTAL PRODUKTION: ${totalProduction.toFixed(1)} kWh\n\n`;
            
            // Stor horisontell "t√•rtgraf" med produktionsf√∂rdelning
            const barWidth = 50;
            const negativeBars = Math.floor(barWidth * negativePercentage);
            const positiveBars = barWidth - negativeBars;
            
            chart += 'PRODUKTIONSF√ñRDELNING:\n';
            chart += '‚îå' + '‚îÄ'.repeat(barWidth) + '‚îê\n';
            chart += '‚îÇ' + '‚ñà'.repeat(negativeBars) + '‚ñì'.repeat(positiveBars) + '‚îÇ\n';
            chart += '‚îî' + '‚îÄ'.repeat(barWidth) + '‚îò\n';
            chart += `  NEGATIV: ${negativeProduction.toFixed(1)} kWh (${(negativePercentage*100).toFixed(1)}%)\n`;
            chart += `  POSITIV: ${positivePriceProduction.toFixed(1)} kWh (${(positivePercentage*100).toFixed(1)}%)\n\n`;
            
            // Vertikal representation f√∂r tydligare √∂versikt
            chart += 'F√ñRDELNING PER KATEGORI:\n\n';
            
            const maxBarLength = 30;
            const negBar = Math.floor(maxBarLength * negativePercentage);
            const posBar = Math.floor(maxBarLength * positivePercentage);
            
            chart += `NEG.PRISER: ${'‚ñà'.repeat(negBar).padEnd(maxBarLength, '.')} ${(negativePercentage*100).toFixed(1)}%\n`;
            chart += `POS.PRISER: ${'‚ñì'.repeat(posBar).padEnd(maxBarLength, '.')} ${(positivePercentage*100).toFixed(1)}%\n\n`;
            
            // Ekonomisk p√•verkan
            if (negativeCost > 0) {
                chart += 'EKONOMISK ANALYS:\n';
                chart += `DIREKT F√ñRLUST:      ${negativeCost.toFixed(0)} SEK\n`;
                
                const avgLossPerKwh = negativeCost / negativeProduction;
                chart += `F√ñRLUST PER kWh:     ${avgLossPerKwh.toFixed(3)} SEK\n\n`;
                
                // Batteripotential - fokus p√• att spara "gratis" el
                const batteryPotential = negativeProduction * 0.5; // Realistisk genomsnittspris
                chart += `üí° BATTERIPOTENTIAL:\n`;
                chart += `SPARBAR ENERGI:      ${negativeProduction.toFixed(1)} kWh\n`;
                chart += `POTENTIELL VINST:    ${batteryPotential.toFixed(0)} SEK\n`;
                chart += `   (vid f√∂rs√§ljning till 0.50 SEK/kWh genomsnitt)\n`;
            }
            
            chart += '\n';
            
            // Rekommendationer baserat p√• andel
            if (negativePercentage > 0.2) {
                chart += 'üî¥ KRITISKT: >20% av produktionen vid negativa priser!\n';
                chart += '   Stark rekommendation: Batterilager + produktionsstyrning\n';
                chart += '   Sourceful Zap kan optimera detta automatiskt.';
            } else if (negativePercentage > 0.1) {
                chart += 'üü° VARNING: >10% av produktionen vid negativa priser\n';
                chart += '   √ñverv√§g batterilager f√∂r att lagra "gratis" el\n';
                chart += '   till b√§ttre tider.';
            } else if (negativePercentage > 0.05) {
                chart += 'üü¢ M√ÖTTLIG: <10% p√•verkan fr√•n negativa priser\n';
                chart += '   Mindre optimering m√∂jlig med smart styrning.';
            } else {
                chart += '‚úÖ UTM√ÑRKT: <5% av produktionen vid negativa priser\n';
                chart += '   Din anl√§ggning har redan bra timing!';
            }

            container.innerHTML = chart;
        }

        // Generate charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            {% if results and results.analysis %}
                const analysisData = {
                    negative_price_hours: {{ results.analysis.negative_price_hours }},
                    total_hours: {{ results.analysis.total_hours }},
                    negative_export_cost_abs_sek: {{ results.analysis.negative_export_cost_abs_sek }},
                    production_during_negative_prices: {{ results.analysis.production_during_negative_prices }},
                    production_total: {{ results.analysis.production_total }}
                };
                generateNegativePriceChart(analysisData, 'negativePriceChart');
            {% endif %}
        });
    </script>
</body>
</html>

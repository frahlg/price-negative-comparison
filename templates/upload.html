<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LADDA UPP DATA - SOURCEFUL ENERGY TERMINAL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">
</head>
<body>
    <div class="terminal-container">
        <!-- Terminal Header -->
        <div class="terminal-system-info">
            SOURCEFUL ENERGY ANALYSIS SYSTEM v1.0<br>
            COPYRIGHT (C) 2025 - SOURCEFUL LABS AB<br>
            DATALADDNING OCH ANALYS<br>
            READY.
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="terminal-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }}">
                        {{ category.upper() }}: {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- ASCII Art Logo -->
        <div class="terminal-ascii">
██╗   ██╗██████╗ ██╗      ██████╗  █████╗ ██████╗ 
██║   ██║██╔══██╗██║     ██╔═══██╗██╔══██╗██╔══██╗
██║   ██║██████╔╝██║     ██║   ██║███████║██║  ██║
██║   ██║██╔═══╝ ██║     ██║   ██║██╔══██║██║  ██║
╚██████╔╝██║     ███████╗╚██████╔╝██║  ██║██████╔╝
 ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ 
                DATA UPLOAD MODE
        </div>

        <div class="terminal-divider"></div>

        <!-- Upload Instructions -->
        <div class="terminal-prompt terminal-text">
            INSTRUKTIONER: LADDA UPP DIN CSV- ELLER EXCEL-FIL MED PRODUKTIONSDATA
        </div>

        <div class="terminal-command-line terminal-text">
            FILFORMAT: CSV, XLS, XLSX - DATUM,PRODUKTION (kWh/MWh)
        </div>
        <div class="terminal-command-line terminal-text">
            EXEMPEL: 2024-01-01 12:00,5.2
        </div>

        <!-- Upload Form -->
        <form id="uploadForm" action="/" method="POST" enctype="multipart/form-data" class="terminal-form">
            
            <!-- Email Input -->
            <label class="terminal-label">E-POST (KRÄVS FÖR ANALYS):</label>
            <input type="email" class="terminal-input" id="email" name="email" placeholder="din.epost@exempel.se" required>
            <div class="terminal-text" style="color: #666666; font-size: 12px; margin-bottom: 20px;">
                Vi sparar din e-post för att kunna skicka dig analysen och framtida uppdateringar.
            </div>

            <!-- File Upload -->
            <label class="terminal-label">PRODUKTIONS- ELLER KONSUMTIONSFIL:</label>
            <div class="terminal-file-area" id="uploadArea">
                <input type="file" id="file" name="file" accept=".csv,.xls,.xlsx" multiple style="display: none;">
                <div class="upload-content">
                    DRA OCH SLÄPP DINA FILER HÄR (CSV/EXCEL)<br>
                    ELLER <span style="color: #ffaa00; cursor: pointer;" onclick="document.getElementById('file').click()">KLICKA FÖR ATT VÄLJA FILER</span><br>
                    <small style="color: #666666;">MAX FILSTORLEK: 16MB PER FIL • STÖDER FLERA FILER</small><br>
                    <small style="color: #888888; margin-top: 5px; display: block;">TIP: Lägg till flera filer genom att dra och släppa eller klicka flera gånger</small>
                </div>
                <div class="files-info" id="filesInfo" style="display: none;">
                    <div class="terminal-text" style="color: #ffaa00; margin-bottom: 10px;">VALDA FILER:</div>
                    <div id="filesList"></div>
                    <div style="margin-top: 10px;">
                        <span style="color: #ffaa00; cursor: pointer;" onclick="document.getElementById('file').click()">+ LÄGG TILL FLER FILER</span>
                    </div>
                </div>
            </div>

            <!-- Area Selection -->
            <label class="terminal-label">ELOMRÅDE:</label>
            <select class="terminal-select" id="area" name="area" required>
                <option value="">VÄLJ ELOMRÅDE...</option>
                <optgroup label="SVERIGE">
                    <option value="SE_1">SE_1 - NORRA SVERIGE</option>
                    <option value="SE_2">SE_2 - MELLERSTA SVERIGE</option>
                    <option value="SE_3">SE_3 - SÖDRA SVERIGE</option>
                    <option value="SE_4" selected>SE_4 - SYDSVERIGE</option>
                </optgroup>
                <optgroup label="NORGE">
                    <option value="NO_1">NO_1 - ÖSTRA NORGE</option>
                    <option value="NO_2">NO_2 - SÖDRA NORGE</option>
                    <option value="NO_3">NO_3 - MELLERSTA NORGE</option>
                    <option value="NO_4">NO_4 - NORRA NORGE</option>
                    <option value="NO_5">NO_5 - VÄSTRA NORGE</option>
                </optgroup>
                <optgroup label="DANMARK">
                    <option value="DK_1">DK_1 - VÄSTRA DANMARK</option>
                    <option value="DK_2">DK_2 - ÖSTRA DANMARK</option>
                </optgroup>
                <optgroup label="FINLAND">
                    <option value="FI">FI - FINLAND</option>
                </optgroup>
            </select>

            <!-- Currency Selection -->
            <label class="terminal-label">VALUTA:</label>
            <select class="terminal-select" id="currency" name="currency">
                <option value="SEK" selected>SEK - SVENSKA KRONOR</option>
                <option value="EUR">EUR - EURO</option>
                <option value="USD">USD - US DOLLAR</option>
                <option value="NOK">NOK - NORSKA KRONOR</option>
                <option value="DKK">DKK - DANSKA KRONOR</option>
                <option value="GBP">GBP - BRITTISKA PUND</option>
            </select>

            <!-- Date Range -->
            <label class="terminal-label">STARTDATUM (VALFRITT):</label>
            <input type="date" class="terminal-input" id="start_date" name="start_date" placeholder="YYYY-MM-DD">

            <label class="terminal-label">SLUTDATUM (VALFRITT):</label>
            <input type="date" class="terminal-input" id="end_date" name="end_date" placeholder="YYYY-MM-DD">

            <!-- Submit Button -->
            <button type="submit" class="terminal-button" id="submitBtn">
                STARTA ANALYS [ENTER]
            </button>

            <!-- Progress Bar -->
            <div class="terminal-progress" id="uploadProgress" style="display: none;">
                <div class="terminal-text">LADDAR UPP OCH ANALYSERAR<span class="terminal-loading"></span></div>
                <div class="terminal-progress-bar">
                    <div class="terminal-progress-fill" id="progressFill"></div>
                </div>
            </div>
        </form>

        <div class="terminal-divider"></div>

        <!-- Help Information -->
        <div class="terminal-prompt">HJÄLP:</div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">FILFORMAT:</span>
            <span class="terminal-metric-value">CSV, XLS, XLSX - AI DETEKTERAR AUTOMATISKT</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">FLERFILSUPPORT:</span>
            <span class="terminal-metric-value">LADDA UPP FLERA FILER SAMTIDIGT</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">KOLUMNER:</span>
            <span class="terminal-metric-value">DATUM/TID, PRODUKTION/KONSUMPTION</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">ENHETER:</span>
            <span class="terminal-metric-value">kWh, MWh, Wh - AI KONVERTERAR AUTOMATISKT</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">DATATYP:</span>
            <span class="terminal-metric-value">AI IDENTIFIERAR PRODUKTION VS KONSUMPTION</span>
        </div>
        <div class="terminal-metric">
            <span class="terminal-metric-label">HEADER:</span>
            <span class="terminal-metric-value">MED ELLER UTAN - AI HITTAR AUTOMATISKT</span>
        </div>

        <div class="terminal-divider"></div>

        <!-- Actions -->
        <div class="terminal-prompt">KOMMANDOALTERNATIV:</div>
        <div style="margin: 20px 0;">
            <a href="/" class="terminal-button" style="display: inline-block; text-decoration: none; margin-right: 20px;">
                TILLBAKA TILL HUVUDMENY
            </a>
            <a href="/status" class="terminal-button" style="display: inline-block; text-decoration: none;">
                SYSTEMSTATUS
            </a>
        </div>

        <!-- Terminal Footer -->
        <div class="terminal-command-line terminal-text" style="text-align: center; color: #666666; margin-top: 40px;">
            KLAR FÖR DATALADDNING - SOURCEFUL ENERGY ZAP VÄNTAR
        </div>

        <div class="terminal-text" style="text-align: center; margin-top: 20px;">
            <span class="cursor"></span>
        </div>
        
        <div class="terminal-text" style="text-align: center; margin-top: 15px; color: #555555; font-size: 12px;">
            Sourceful Labs AB • Made in Kalmar, Sweden • Sourceful Energy™
        </div>
    </div>

    <!-- Terminal JavaScript -->
    <script>
        // File upload handling
        const fileInput = document.getElementById('file');
        const uploadArea = document.getElementById('uploadArea');
        const uploadContent = uploadArea.querySelector('.upload-content');
        const filesInfo = document.getElementById('filesInfo');
        const filesList = document.getElementById('filesList');
        const form = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressArea = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        
        // Use a simple array to store files instead of DataTransfer
        let selectedFiles = [];

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addFiles(files);
            
            // Clear the file input so the same file can be selected again if needed
            e.target.value = '';
        });

        function addFiles(files) {
            const validExtensions = ['.csv', '.xls', '.xlsx'];
            let validFiles = [];
            let invalidFiles = [];
            
            files.forEach(file => {
                const isValidFile = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
                if (isValidFile && file.size <= 16 * 1024 * 1024) { // 16MB limit
                    // Check if file already exists
                    let alreadyExists = selectedFiles.some(existingFile => 
                        existingFile.name === file.name && existingFile.size === file.size
                    );
                    
                    if (!alreadyExists) {
                        validFiles.push(file);
                    }
                } else {
                    invalidFiles.push(file.name);
                }
            });
            
            if (invalidFiles.length > 0) {
                alert('FEL: FÖLJANDE FILER KUNDE INTE LADDAS:\\n' + invalidFiles.join('\\n') + '\\n\\nSTÖDDA FORMAT: CSV, XLS, XLSX - MAX 16MB PER FIL');
            }
            
            // Add valid files to selectedFiles array
            selectedFiles.push(...validFiles);
            
            // Update the hidden file input with all files
            updateFileInput();
            updateFilesList();
            
            // Show confirmation when files are added
            if (validFiles.length > 0) {
                const fileNames = validFiles.map(f => f.name).join(', ');
                console.log(`Lade till ${validFiles.length} fil(er): ${fileNames}`);
                console.log(`Totalt antal filer: ${selectedFiles.length}`);
            }
        }

        function updateFileInput() {
            // Skip DataTransfer - we'll handle files directly in form submission
            console.log(`Updated file input with ${selectedFiles.length} files`);
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileInput();
            updateFilesList();
        }

        function updateFilesList() {
            if (selectedFiles.length === 0) {
                uploadContent.style.display = 'block';
                filesInfo.style.display = 'none';
                return;
            }
            
            uploadContent.style.display = 'none';
            filesInfo.style.display = 'block';
            
            // Update the header to show file count
            const filesHeader = document.querySelector('#filesInfo .terminal-text');
            if (selectedFiles.length === 1) {
                filesHeader.textContent = 'VALD FIL:';
            } else {
                filesHeader.textContent = `VALDA FILER (${selectedFiles.length} st):`;
            }
            
            filesList.innerHTML = '';
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileDiv = document.createElement('div');
                fileDiv.style.cssText = 'margin: 5px 0; padding: 8px; background: #1a1a1a; border-left: 3px solid #ffaa00; border-radius: 3px;';
                
                // Add file number for multiple files
                const fileNumber = selectedFiles.length > 1 ? `[${i + 1}] ` : '';
                
                fileDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #ffaa00; font-weight: bold;">${fileNumber}${file.name}</span>
                            <span style="color: #666666; margin-left: 10px;">(${formatFileSize(file.size)})</span>
                        </div>
                        <span style="color: #ff4444; cursor: pointer; padding: 2px 8px; background: #331111; border-radius: 3px;" onclick="removeFile(${i})" title="Ta bort denna fil">✕</span>
                    </div>
                `;
                filesList.appendChild(fileDiv);
            }
            
            // Update the "add more files" text
            const addMoreSpan = document.querySelector('#filesInfo div:last-child span');
            if (addMoreSpan) {
                addMoreSpan.textContent = `+ LÄGG TILL FLER FILER (${selectedFiles.length} valda)`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 BYTES';
            const k = 1024;
            const sizes = ['BYTES', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission with progress
        form.addEventListener('submit', (e) => {
            e.preventDefault(); // Prevent default form submission
            
            // Check if we have files
            if (selectedFiles.length === 0) {
                alert('VÄLJ MINST EN FIL INNAN DU STARTAR ANALYSEN');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ANALYSERAR...';
            progressArea.style.display = 'block';
            
            // Create FormData and add our selected files
            const formData = new FormData();
            
            // Add all form fields
            formData.append('email', document.getElementById('email').value);
            formData.append('area', document.getElementById('area').value);
            formData.append('currency', document.getElementById('currency').value);
            formData.append('start_date', document.getElementById('start_date').value);
            formData.append('end_date', document.getElementById('end_date').value);
            
            // Add all selected files
            selectedFiles.forEach((file, index) => {
                formData.append('file', file);
            });
            
            console.log(`Skickar ${selectedFiles.length} filer till servern`);
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 200);

            // Submit with fetch
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                if (response.ok) {
                    // Redirect to results or handle success
                    window.location.href = response.url;
                } else {
                    throw new Error('Upload failed');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Upload error:', error);
                alert('FEL VID UPPLADDNING: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'STARTA ANALYS [ENTER]';
                progressArea.style.display = 'none';
            });
        });

        // Terminal typing effect for cursor
        const cursor = document.querySelector('.cursor');
        setInterval(() => {
            cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
        }, 500);
    </script>
</body>
</html>
